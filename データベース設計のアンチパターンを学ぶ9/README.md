# データベース設計のアンチパターンを学ぶ9

## PostgreSQLの各機能についての調査
### CHECK
- 列制約：列に登録する値に対して、条件式を設定可能
- テーブル制約：テーブルに登録する値に対して、テーブル内の列を登録値に対する条件式を設定可能
- 制約には名前を付けることが可能
- 対象行の追加・更新時のみ検査が行われる
  - 他テーブルを外部参照した列に対して「ON UPDATE」を設定している場合、カスケード更新時は検査が行われない？

### ENUM
- 列挙した値のみ登録可能なデータ型を定義できる。textやintegerと同様に使用する
- 列挙内に無い値を登録しようとするとErrorになる
- テーブル作成時に特定の列に対してのみ宣言することも可能
- 列挙値は大文字と小文字を区別する
- pg_enumから作成した列挙型を取得可能
- 後から列挙値を追加することは簡単
- 列挙値の一覧取得が面倒

### DOMAIN
- 登録値について詳細な設定が可能なデータ型を作成する
  - データ型名
  - 基本となるデータ型
  - デフォルト値
  - NULL可 or NOT NULL
  - CHECK制約
- 一度定義すると複数の列で使用可能
- DB製品によっては機能がない場合がある

### Trigger
- テーブルやビューに対してイベントが発生したタイミングでトリガプロシージャを呼び出す機能
- タイミングは「イベント前」「イベント後」「イベントの代わり」を指定可能
- FOR EACH ROW付きのトリガは、そのイベントによって変更される行数回分、トリガプロシージャを起動する
- 主な用途
  - イベントロギング
  - 導出項目・集計値の自動生成
  - ビジネスルールの実現
- DBにもロジックが存在するのでビジネスロジック全体の理解・管理が難しくなる
- テーブル間の依存性が発生する

<br>

## 課題1

### Checkを使うべきか？
使うべきではない。理由は
- 他のドメインのアドレスも使用することになった場合、CHECK制約を削除後に新しく追加する必要がある(変更できなそう？)
  - サービスを一時的に停止する必要がある
- 「mailAddress」というカラム名からは「特定のドメインのみ許可する」というルールが読み取れないため誤解が生じる
- 値の内容のチェックはDBの責務ではなくアプリケーション側の責務のような気がする(自信無いので話したい)
  - 「メールアドレス形式のみ許可する」という制約であればカラム名とも合っているので使ってもいいかと思う

### Triggerを使うべきか？
使うべきではない。理由は
- 基本的にDB側がロジックを持つべきではない
- 「削除したUserはWithdrawnUserに移動する」というロジックが分離するため。「退会したユーザ情報は管理しないんだ」という誤解が生じる
- アプリケーション側に「WithdrawnUserに移動する」ロジックを作る工数はそれほど多くなさそう

### Enumを使うべきか？
使うべきではない。理由は
- 値の内容が変わる可能性がある
- 選択肢の一覧を取得するのが面倒

### Domainを使うべきか？
使うべきではない。理由は
-  全ユーザのpostalCodeの形式が一致するとは限らないため
   -  日本ユーザと海外ユーザの場合、郵便番号の形式が違う

### 制約はアプリケーション側かDB側か
基本的に制約はアプリケーション側で課すべきで、DB側で課すのはなるべく控えた方がいいと考える。  
DB側で課してもいいケースとしては、まずアプリケーション側で制約を課した上で、  
制約の内容が変更されないと断言でき、かつDB内で頻繁に使用する形式のカラムに対して補助的に課すのはいいと考える。理由は  
- DB側で制約を課すと、アプリケーションコードだけではDBに登録される値の内容が分からなくなる
- 「一部のカラムはDB側で制約を設けている」という認識があると、調査の際に、結局全ての値のDB側の制約を確認しなくてはならない
- DB側の制約はGitで管理ができない
- DB側で制約を課すと、制約が変更になった場合にテーブル定義を変更しなくてはならないため面倒

<br>

## 課題2
いずれの制約もカラムに格納する値の考慮が足りない場合に発生する可能性が高い。  

Enumはタグや状態などを選択肢から選ぶような機能がある場合に発生しそう。
- タスク管理サービスで、タスクの進捗状況を選択できるが、後の要望で種類が増えた場合
- 記事管理サービスで、記事へのタグを付与する場合

CHECKやDOMAINは、値の形式が外部で決定されている場合に発生しそう
- マイナンバー
- 年金番号
- 免許番号
- JANコード

Triggerはビジネスロジックに関連するデータ操作をした場合に発生しそう
- ブログサービスでdelete_flgを用いている場合、記事を論理削除した際に、記事に紐づく各テーブルも論理削除する処理をTriggerで実装

<br>

## 参考記事
- [PostgreSQL 13.1文書 5.4. 制約](https://www.postgresql.jp/document/13/html/ddl-constraints.html)
- [PostgreSQL 8.4.4文書 8.7. 列挙型](https://www.postgresql.jp/document/8.4/html/datatype-enum.html)
- [PostgreSQL 9.2.4文書 CREATE DOMAIN](https://www.postgresql.jp/docs/9.2/sql-createdomain.html)
- [トリガ・トリガプロシージャの使い方（PostgreSQL）](https://qiita.com/jiyu58546526/items/7a9b0dafce961466ba7d#:~:text=%E3%83%88%E3%83%AA%E3%82%AC%E3%81%A8%E3%81%AF%E3%80%81%E3%81%82%E3%82%8B%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB,%E3%82%82%E3%81%AE%EF%BC%89%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99%E6%A9%9F%E8%83%BD%E3%81%A7%E3%81%99%E3%80%82)
- [3分でわかるトリガー -使い所と問題点を考える-](https://qiita.com/wanko5296/items/fa3620c48196acbd3ab6)
- [[データベース編]ビュー，トリガーを多用してはいけない](https://xtech.nikkei.com/it/article/COLUMN/20071126/287920/)
- [便利なデータベーストリガーを正しく使おう！](https://blog.recruit.co.jp/rmp/server-side/post-17798/)
- [MySQL Triggerのデメリットが大きいので使わないで欲しい](https://www.banana-juice.com/tech/articles/mysql/trigger-demerit)
- [PostgreSQL 9.4.5文書 CREATE TRIGGER](https://www.postgresql.jp/docs/9.4/sql-createtrigger.html)
